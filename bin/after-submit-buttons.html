<script type="text/javascript">
    var formDefaultValues; // Initial values for form inputs.
    // Monkey patch load_callprefix:
    for (var i = startup_functions.length - 1; i >= 0; i--) {
        if (startup_functions[i] === load_callprefix) {
            startup_functions[i] = function(next) {
                load_callprefix(function() {
                    try {
                        const message = {{message}};
                        if (message) {
                            set_form_data_div(message);
                        }
                        const queryDefaults = {{queryDefaults}};
                        for (var i in queryDefaults) {
                            if (query_object[i] === undefined) {
                                query_object[i] = queryDefaults[i];
                            }
                        }
                        if (query_object.submitURL) {
                            document.querySelector('#form-data-form').action = query_object.submitURL;
                        }
                        if (query_object.pingURL && query_object.mode != 'readonly') {
                            // Ping the server periodically, to keep it alive while the form is open.
                            // But don't keep the server alive for a read-only message.
                            setInterval(function() {
                                var img = new Image();
                                img.src = query_object.pingURL;
                                img = undefined;
                            }, 30000); // call ping every 30 seconds
                        }
                        if (formDefaultValues) {
                            for (var f = formDefaultValues.length - 1; f >= 0; f--) {
                                init_form_from_fields(formDefaultValues[f], 'name');
                            }
                        }
                    } catch(err) {
                        // TODO: log the error
                    }
                    next();
                });
            };
            break;
        }
    }
</script>
